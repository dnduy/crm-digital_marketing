<?php
function view_users($op){ global $db; require_admin(); layout_header('Người dùng'); if($op==='create'&&$_SERVER['REQUEST_METHOD']==='POST'){ require_csrf(); $u=trim($_POST['username']??''); $p=trim($_POST['password']??''); $r=$_POST['role']??'Editor'; if(!$u||!$p){ $_SESSION['flash']='Thiếu username/password'; header('Location: ?action=users'); exit; } $hash=password_hash($p,PASSWORD_DEFAULT); q($db,"INSERT INTO users(username,password_hash,role) VALUES(?,?,?)",[$u,$hash,$r]); header('Location: ?action=users'); exit; } if($op==='reset'&&$_SERVER['REQUEST_METHOD']==='POST'){ require_csrf(); $id=(int)$_POST['id']; $p=trim($_POST['password']??''); if($p){ $hash=password_hash($p,PASSWORD_DEFAULT); q($db,"UPDATE users SET password_hash=? WHERE id=?",[$hash,$id]); } header('Location: ?action=users'); exit; } if($op==='role'){ $id=(int)($_GET['id']??0); $r=$_GET['to']??'Editor'; q($db,"UPDATE users SET role=? WHERE id=?",[$r,$id]); header('Location: ?action=users'); exit; } if($op==='delete'){ $id=(int)($_GET['id']??0); if($id===$_SESSION['uid']){ die('Không thể xoá chính mình'); } q($db,'DELETE FROM users WHERE id=?',[$id]); header('Location: ?action=users'); exit; }
  echo '<div class="card"><h3>Thêm người dùng</h3><form method="post" action="?action=users&op=create">'; csrf_field(); echo '<div class="grid cols-3"><div><label>Username</label><input name="username" required></div><div><label>Password</label><input name="password" type="password" required></div><div><label>Role</label><select name="role"><option>Admin</option><option selected>Editor</option></select></div></div><div style="margin-top:12px"><button class="btn">Tạo</button></div></form></div>';
  echo '<div class="card"><h3>Danh sách</h3>'; $rows=q($db,'SELECT * FROM users ORDER BY id DESC')->fetchAll(PDO::FETCH_ASSOC); echo '<table><tr><th>ID</th><th>User</th><th>Role</th><th>Tạo lúc</th><th>Đổi mật khẩu</th><th>Hành động</th></tr>'; foreach($rows as $r){ echo '<tr><td>'.(int)$r['id'].'</td><td>'.h($r['username']).'</td><td>'.h($r['role']).'</td><td>'.h($r['created_at']).'</td><td><form method="post" action="?action=users&op=reset" style="display:flex;gap:6px">'; csrf_field(); echo '<input type="hidden" name="id" value="'.(int)$r['id'].'"><input name="password" type="password" placeholder="mật khẩu mới"><button class="btn secondary">Đổi</button></form></td><td><a class="btn secondary" href="?action=users&op=role&id='.(int)$r['id'].'&to='.( $r['role']==='Admin'?'Editor':'Admin').'">Chuyển '.( $r['role']==='Admin'?'Editor':'Admin').'</a> '.($r['id']!==(int)$_SESSION['uid']?'<a class="btn secondary" href="?action=users&op=delete&id='.(int)$r['id'].'" onclick="return confirm('Xoá user?')">Xoá</a>':'').'</td></tr>'; } echo '</table></div>';
  $sec=setting_get('webhook_secret',''); echo '<div class="card"><h3>Webhook Secret</h3><div>'.h($sec ?: 'Chưa tạo (mở Dashboard để tự sinh)').'</div></div>';
  layout_footer(); }
