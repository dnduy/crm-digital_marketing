<?php
function view_activities($op){ global $db; layout_header('Hoạt động'); if($op==='create'&&$_SERVER['REQUEST_METHOD']==='POST'){ require_csrf(); q($db,"INSERT INTO activities(contact_id,type,content,at) VALUES(?,?,?,?)",[$_POST['contact_id']?:null,$_POST['type']??'note',$_POST['content']??'',$_POST['at']?:date('Y-m-d H:i:s')]); header('Location: ?action=activities'); exit; } if($op==='delete'){ q($db,"DELETE FROM activities WHERE id=?",[(int)($_GET['id']??0)]); header('Location: ?action=activities'); exit; } if($op==='new'){ $contacts=q($db,'SELECT id,name FROM contacts ORDER BY name')->fetchAll(PDO::FETCH_ASSOC); echo '<div class="card"><h3>Ghi hoạt động</h3><form method="post" action="?action=activities&op=create">'; csrf_field(); echo '<div class="grid cols-3"><div><label>Liên hệ</label><select name="contact_id"><option value="">—</option>'; foreach($contacts as $c){ $sel=(($_GET['contact_id']??'')==$c['id'])?'selected':''; echo '<option '.$sel.' value="'.$c['id'].'">'.h($c['name']).'</option>'; } echo '</select></div><div><label>Loại</label><select name="type">'; foreach(['note','call','meeting','email'] as $t){ echo '<option>'.$t.'</option>'; } echo '</select></div><div><label>Thời gian</label><input name="at" type="datetime-local"></div></div><div><label>Nội dung</label><textarea name="content" rows="4"></textarea></div><div style="margin-top:12px"><button class="btn">Lưu</button> <a class="btn secondary" href="?action=activities">Huỷ</a></div></form></div>'; } echo '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><h3>Tất cả hoạt động</h3><a class="btn" href="?action=activities&op=new">Thêm</a></div>'; $rows=q($db,"SELECT a.*, c.name as contact_name FROM activities a LEFT JOIN contacts c ON c.id=a.contact_id ORDER BY a.at DESC LIMIT 200")->fetchAll(PDO::FETCH_ASSOC); echo '<table><tr><th>Khi nào</th><th>Loại</th><th>Liên hệ</th><th>Nội dung</th><th></th></tr>'; foreach($rows as $r){ echo '<tr><td>'.h($r['at']).'</td><td>'.h($r['type']).'</td><td>'.h($r['contact_name']).'</td><td>'.h($r['content']).'</td><td><a href="?action=activities&op=delete&id='.(int)$r['id'].'" onclick="return confirm(\'Xoá?\')">Xoá</a></td></tr>'; } echo '</table></div>'; layout_footer(); }
