<?php

namespace AI\Providers;

use AI\AIProviderInterface;
use Core\Logger;

/**
 * Gemini (Google AI) Provider
 * Integrates with Google's Gemini API for content generation
 */
class GeminiProvider implements AIProviderInterface
{
    private string $apiKey;
    private string $model;
    private int $maxTokens;
    private Logger $logger;
    private string $baseUrl = 'https://generativelanguage.googleapis.com/v1beta';

    public function __construct(string $apiKey, string $model = 'gemini-pro', int $maxTokens = 8192, Logger $logger = null)
    {
        $this->apiKey = $apiKey;
        $this->model = $model;
        $this->maxTokens = $maxTokens;
        $this->logger = $logger ?: new Logger();
    }

    public function generateContent(string $prompt, array $options = []): string
    {
        $systemPrompt = $this->buildSystemPrompt($options);
        $fullPrompt = $systemPrompt . "\n\n" . $prompt;
        
        $data = [
            'contents' => [
                [
                    'parts' => [
                        ['text' => $fullPrompt]
                    ]
                ]
            ],
            'generationConfig' => [
                'temperature' => $options['temperature'] ?? 0.7,
                'topK' => $options['top_k'] ?? 40,
                'topP' => $options['top_p'] ?? 0.95,
                'maxOutputTokens' => $options['max_tokens'] ?? $this->maxTokens,
                'stopSequences' => $options['stop_sequences'] ?? []
            ],
            'safetySettings' => [
                [
                    'category' => 'HARM_CATEGORY_HARASSMENT',
                    'threshold' => 'BLOCK_MEDIUM_AND_ABOVE'
                ],
                [
                    'category' => 'HARM_CATEGORY_HATE_SPEECH',
                    'threshold' => 'BLOCK_MEDIUM_AND_ABOVE'
                ],
                [
                    'category' => 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
                    'threshold' => 'BLOCK_MEDIUM_AND_ABOVE'
                ],
                [
                    'category' => 'HARM_CATEGORY_DANGEROUS_CONTENT',
                    'threshold' => 'BLOCK_MEDIUM_AND_ABOVE'
                ]
            ]
        ];

        try {
            $response = $this->makeRequest("models/{$this->model}:generateContent", $data);
            $content = $response['candidates'][0]['content']['parts'][0]['text'] ?? '';
            
            $this->logger->info('AI Content Generated', [
                'provider' => 'gemini',
                'model' => $this->model,
                'prompt_length' => strlen($prompt),
                'response_length' => strlen($content)
            ]);
            
            return $content;
        } catch (\Exception $e) {
            $this->logger->error('AI Content Generation Failed', [
                'provider' => 'gemini',
                'error' => $e->getMessage()
            ]);
            throw $e;
        }
    }

    public function improveContent(string $content, string $type = 'blog'): string
    {
        $prompt = "C·∫£i thi·ªán n·ªôi dung {$type} sau ƒë√¢y theo c√°c ti√™u ch√≠ ch·∫•t l∆∞·ª£ng cao:

üéØ N·ªòI DUNG C·∫¶N C·∫¢I THI·ªÜN:
{$content}

üìã Y√äU C·∫¶U C·∫¢I THI·ªÜN:
‚úì T·ªëi ∆∞u SEO v·ªõi t·ª´ kh√≥a t·ª± nhi√™n
‚úì C·∫£i thi·ªán c·∫•u tr√∫c v√† lu·ªìng th√¥ng tin
‚úì TƒÉng t√≠nh h·∫•p d·∫´n v√† engagement
‚úì S·ª≠ d·ª•ng ng√¥n ng·ªØ ph√π h·ª£p v·ªõi ƒë·ªëi t∆∞·ª£ng Vi·ªát Nam
‚úì B·ªï sung call-to-action hi·ªáu qu·∫£
‚úì ƒê·∫£m b·∫£o t√≠nh ch√≠nh x√°c v√† ƒë√°ng tin c·∫≠y

üé® STYLE GUIDE:
- Gi·ªØ nguy√™n tone g·ªëc nh∆∞ng l√†m cho sinh ƒë·ªông h∆°n
- S·ª≠ d·ª•ng bullet points v√† formatting ph√π h·ª£p
- Th√™m emojis n·∫øu ph√π h·ª£p v·ªõi lo·∫°i content
- ƒê·∫£m b·∫£o d·ªÖ ƒë·ªçc tr√™n mobile";
        
        return $this->generateContent($prompt, [
            'type' => 'content_improvement',
            'content_type' => $type,
            'temperature' => 0.6  // Balanced creativity for improvement
        ]);
    }

    public function generateSocialMediaPost(string $content, string $platform = 'facebook'): string
    {
        $platformSpecs = $this->getSocialMediaSpecs($platform);
        $prompt = "T·∫°o m·ªôt {$platform} post viral t·ª´ n·ªôi dung sau:

üìù N·ªòI DUNG G·ªêC:
{$content}

üéØ Y√äU C·∫¶U CHO {$platform}:
{$platformSpecs['instructions']}

üìä GI·ªöI H·∫†N:
- T·ªëi ƒëa {$platformSpecs['character_limit']} k√Ω t·ª±
- S·ª≠ d·ª•ng {$platformSpecs['hashtag_count']} hashtags ph√π h·ª£p
- C√≥ emoji thu h√∫t {$platformSpecs['emoji_style']}

üöÄ CHI·∫æN L∆Ø·ª¢C CONTENT:
- Hook m·∫°nh m·∫Ω ngay c√¢u ƒë·∫ßu
- Storytelling h·∫•p d·∫´n (n·∫øu c√≥ ch·ªó)
- Call-to-action r√µ r√†ng
- T·∫≠n d·ª•ng trends hi·ªán t·∫°i c·ªßa {$platform}

Tr·∫£ v·ªÅ post ho√†n ch·ªânh ready ƒë·ªÉ publish:";
        
        return $this->generateContent($prompt, [
            'type' => 'social_media',
            'platform' => $platform,
            'max_tokens' => $platformSpecs['max_tokens'],
            'temperature' => 0.9  // High creativity for social media
        ]);
    }

    public function generateSEOMetadata(string $content, string $targetKeyword = ''): array
    {
        $prompt = "T·∫°o SEO metadata t·ªëi ∆∞u cho n·ªôi dung sau. Ph√¢n t√≠ch k·ªπ content v√† target keyword ƒë·ªÉ t·∫°o metadata hi·ªáu qu·∫£ nh·∫•t.

üéØ TARGET KEYWORD: {$targetKeyword}

üìÑ N·ªòI DUNG:
{$content}

üîç Y√äU C·∫¶U SEO METADATA:

1. **TITLE TAG** (50-60 k√Ω t·ª±):
   - Ch·ª©a target keyword ·ªü v·ªã tr√≠ ƒë·∫ßu
   - H·∫•p d·∫´n v√† click-worthy
   - Ph√π h·ª£p v·ªõi search intent

2. **META DESCRIPTION** (150-160 k√Ω t·ª±):
   - T√≥m t·∫Øt h·∫•p d·∫´n n·ªôi dung
   - C√≥ target keyword t·ª± nhi√™n
   - Call-to-action r√µ r√†ng
   - T·∫°o desire click

3. **KEYWORDS** (5-10 t·ª´ kh√≥a):
   - Primary keyword
   - LSI keywords
   - Long-tail variations
   - Related terms

4. **OPEN GRAPH**:
   - OG title t·ªëi ∆∞u social sharing
   - OG description h·∫•p d·∫´n

5. **SCHEMA MARKUP**:
   - ƒê·ªÅ xu·∫•t schema types ph√π h·ª£p
   - Structured data recommendations

üìä Tr·∫£ v·ªÅ format JSON chu·∫©n:
```json
{
  \"title\": \"...\",
  \"description\": \"...\",
  \"keywords\": [...],
  \"og_title\": \"...\",
  \"og_description\": \"...\",
  \"schema_suggestions\": [...],
  \"seo_score\": 85,
  \"optimization_tips\": [...]
}
```";
        
        $response = $this->generateContent($prompt, [
            'type' => 'seo_metadata',
            'target_keyword' => $targetKeyword,
            'temperature' => 0.3  // Low temperature for structured output
        ]);

        return $this->parseSEOMetadata($response);
    }

    public function analyzeContentSentiment(string $content): array
    {
        $prompt = "Ph√¢n t√≠ch chi ti·∫øt sentiment v√† emotion c·ªßa n·ªôi dung marketing sau. Cung c·∫•p insights actionable cho content optimization.

üìù N·ªòI DUNG PH√ÇN T√çCH:
{$content}

üéØ Y√äU C·∫¶U PH√ÇN T√çCH:

1. **SENTIMENT OVERVIEW**:
   - Overall sentiment score (-1 to 1)
   - Sentiment classification
   - Confidence level

2. **EMOTION DETECTION**:
   - Primary emotions v·ªõi scores
   - Secondary emotions
   - Emotional journey through content

3. **LINGUISTICS ANALYSIS**:
   - Key phrases ·∫£nh h∆∞·ªüng sentiment
   - Tone markers
   - Language patterns

4. **MARKETING INSIGHTS**:
   - Brand perception implications
   - Audience response predictions
   - Content optimization opportunities

5. **ACTIONABLE RECOMMENDATIONS**:
   - Specific improvements
   - Tone adjustments
   - Engagement optimization

üìä Tr·∫£ v·ªÅ JSON format chi ti·∫øt:
```json
{
  \"sentiment_score\": 0.75,
  \"sentiment_label\": \"positive\",
  \"confidence\": 0.92,
  \"emotions\": {
    \"joy\": 0.4,
    \"trust\": 0.3,
    \"excitement\": 0.25,
    \"anticipation\": 0.05
  },
  \"key_phrases\": {
    \"positive\": [...],
    \"negative\": [...],
    \"neutral\": [...]
  },
  \"tone_markers\": [...],
  \"marketing_insights\": {
    \"brand_perception\": \"...\",
    \"audience_response\": \"...\",
    \"conversion_potential\": \"high\"
  },
  \"recommendations\": [...]
}
```";
        
        $response = $this->generateContent($prompt, [
            'type' => 'sentiment_analysis',
            'temperature' => 0.1  // Very low temperature for analysis
        ]);

        return $this->parseSentimentAnalysis($response);
    }

    /**
     * Advanced content generation with Gemini's multimodal capabilities
     */
    public function generateContentWithContext(string $prompt, array $context = [], array $options = []): string
    {
        $contextPrompt = "";
        
        if (!empty($context['brand_voice'])) {
            $contextPrompt .= "\nüé≠ BRAND VOICE: " . $context['brand_voice'];
        }
        
        if (!empty($context['target_audience'])) {
            $contextPrompt .= "\nüë• TARGET AUDIENCE: " . $context['target_audience'];
        }
        
        if (!empty($context['content_goals'])) {
            $contextPrompt .= "\nüéØ CONTENT GOALS: " . implode(', ', $context['content_goals']);
        }
        
        if (!empty($context['competitors_analysis'])) {
            $contextPrompt .= "\nüè¢ COMPETITIVE LANDSCAPE: " . $context['competitors_analysis'];
        }
        
        $enhancedPrompt = $contextPrompt . "\n\n" . $prompt;
        
        return $this->generateContent($enhancedPrompt, array_merge($options, [
            'type' => 'contextual_content',
            'temperature' => 0.8
        ]));
    }

    /**
     * Build system prompt based on options
     */
    private function buildSystemPrompt(array $options): string
    {
        $basePrompt = "B·∫°n l√† AI Content Marketing Expert h√†ng ƒë·∫ßu Vi·ªát Nam, chuy√™n t·∫°o content ch·∫•t l∆∞·ª£ng cao v·ªõi kh·∫£ nƒÉng understanding s√¢u v·ªÅ market Vi·ªát Nam v√† international best practices.";
        
        $type = $options['type'] ?? 'general';
        
        switch ($type) {
            case 'content_improvement':
                return $basePrompt . "\n\nüéØ CHUY√äN M√îNG: Content Optimization & Enhancement\n- Ph√¢n t√≠ch content existing v√† identify improvement opportunities\n- Apply SEO best practices v√† engagement optimization\n- Maintain brand voice consistency trong qu√° tr√¨nh improvement\n- Focus v√†o conversion optimization v√† user experience";
                
            case 'social_media':
                $platform = $options['platform'] ?? 'facebook';
                return $basePrompt . "\n\nüì± CHUY√äN M√îNG: {$platform} Content Creation\n- Hi·ªÉu r√µ algorithm v√† user behavior tr√™n {$platform}\n- T·∫°o content viral potential cao\n- Optimize cho engagement metrics\n- Apply platform-specific best practices\n- Understand Vietnamese social media culture";
                
            case 'seo_metadata':
                return $basePrompt . "\n\nüîç CHUY√äN M√îNG: SEO & Metadata Optimization\n- Expert trong technical SEO v√† on-page optimization\n- Hi·ªÉu r√µ search intent v√† keyword research\n- T·∫°o metadata t·ªëi ∆∞u cho both search engines v√† users\n- Apply structured data v√† schema markup knowledge\n- Focus v√†o CTR optimization";
                
            case 'sentiment_analysis':
                return $basePrompt . "\n\nüß† CHUY√äN M√îNG: Content Psychology & Sentiment Analysis\n- Ph√¢n t√≠ch s√¢u emotion v√† psychological triggers\n- Understanding cultural context c·ªßa Vietnamese audience\n- Identify brand perception implications\n- Provide actionable insights cho content optimization\n- Expert trong consumer psychology";
                
            case 'contextual_content':
                return $basePrompt . "\n\nüé® CHUY√äN M√îNG: Strategic Content Creation\n- T·∫°o content v·ªõi deep understanding v·ªÅ brand context\n- Apply advanced marketing psychology\n- Optimize cho specific business objectives\n- Balance creativity v·ªõi conversion focus\n- Expert trong omnichannel content strategy";
                
            default:
                return $basePrompt . "\n\nüí° MISSION: T·∫°o content marketing ƒë·∫≥ng c·∫•p international v·ªõi localization ho√†n h·∫£o cho th·ªã tr∆∞·ªùng Vi·ªát Nam";
        }
    }

    /**
     * Get social media platform specifications
     */
    private function getSocialMediaSpecs(string $platform): array
    {
        $specs = [
            'facebook' => [
                'character_limit' => 2000,
                'max_tokens' => 600,
                'hashtag_count' => '3-5',
                'emoji_style' => 'moderate, professional',
                'instructions' => 'Facebook ∆∞u ti√™n storytelling, community building, v√† meaningful conversations. Focus v√†o engagement quality h∆°n quantity. C√≥ th·ªÉ d√†i ƒë·ªÉ k·ªÉ story compelling.'
            ],
            'instagram' => [
                'character_limit' => 2200,
                'max_tokens' => 500,
                'hashtag_count' => '8-15',
                'emoji_style' => 'creative, visual-friendly',
                'instructions' => 'Instagram l√† visual-first platform. Caption h·ªó tr·ª£ image/video story. Hashtag strategy r·∫•t quan tr·ªçng. Focus v√†o aesthetic v√† inspiration.'
            ],
            'twitter' => [
                'character_limit' => 280,
                'max_tokens' => 120,
                'hashtag_count' => '1-3',
                'emoji_style' => 'minimal, impactful',
                'instructions' => 'Twitter demand brevity v√† wit. Thread n·∫øu c·∫ßn elaborate. Real-time trends integration. Focus v√†o virality v√† discussion sparking.'
            ],
            'linkedin' => [
                'character_limit' => 1300,
                'max_tokens' => 400,
                'hashtag_count' => '3-5',
                'emoji_style' => 'professional, minimal',
                'instructions' => 'LinkedIn c·∫ßn professional tone v·ªõi thought leadership angle. Industry insights, business tips, career advice. B2B focused content performs best.'
            ],
            'tiktok' => [
                'character_limit' => 150,
                'max_tokens' => 100,
                'hashtag_count' => '3-6',
                'emoji_style' => 'fun, trendy',
                'instructions' => 'TikTok caption ng·∫Øn, support video content. Trend integration essential. Young audience focus. Hook trong 3 gi√¢y ƒë·∫ßu.'
            ],
            'youtube' => [
                'character_limit' => 5000,
                'max_tokens' => 800,
                'hashtag_count' => '3-5',
                'emoji_style' => 'descriptive, engaging',
                'instructions' => 'YouTube description d√†i ƒë·ªÉ SEO. Include timestamps, links, CTAs. Support video content v·ªõi additional context v√† resources.'
            ]
        ];

        return $specs[$platform] ?? $specs['facebook'];
    }

    /**
     * Parse SEO metadata response
     */
    private function parseSEOMetadata(string $response): array
    {
        try {
            // Extract JSON from response
            if (preg_match('/```json\s*(.*?)\s*```/s', $response, $matches)) {
                $data = json_decode($matches[1], true);
                if ($data) return $data;
            }
            
            if (preg_match('/\{.*\}/s', $response, $matches)) {
                $data = json_decode($matches[0], true);
                if ($data) return $data;
            }
            
            return $this->fallbackParseSEOMetadata($response);
            
        } catch (\Exception $e) {
            $this->logger->warning('Failed to parse SEO metadata', ['error' => $e->getMessage()]);
            return $this->getDefaultSEOMetadata();
        }
    }

    /**
     * Parse sentiment analysis response
     */
    private function parseSentimentAnalysis(string $response): array
    {
        try {
            if (preg_match('/```json\s*(.*?)\s*```/s', $response, $matches)) {
                $data = json_decode($matches[1], true);
                if ($data) return $data;
            }
            
            if (preg_match('/\{.*\}/s', $response, $matches)) {
                $data = json_decode($matches[0], true);
                if ($data) return $data;
            }
            
            return $this->fallbackParseSentiment($response);
            
        } catch (\Exception $e) {
            $this->logger->warning('Failed to parse sentiment analysis', ['error' => $e->getMessage()]);
            return $this->getDefaultSentimentAnalysis();
        }
    }

    /**
     * Make HTTP request to Gemini API
     */
    private function makeRequest(string $endpoint, array $data): array
    {
        $url = $this->baseUrl . '/' . $endpoint . '?key=' . $this->apiKey;
        
        $headers = [
            'Content-Type: application/json'
        ];

        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $url,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => json_encode($data),
            CURLOPT_HTTPHEADER => $headers,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 60,
            CURLOPT_SSL_VERIFYPEER => true
        ]);

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $error = curl_error($ch);
        curl_close($ch);

        if ($error) {
            throw new \Exception("Gemini API request failed: " . $error);
        }

        if ($httpCode !== 200) {
            $errorData = json_decode($response, true);
            $message = $errorData['error']['message'] ?? 'Unknown error';
            throw new \Exception("Gemini API error ({$httpCode}): " . $message);
        }

        $decodedResponse = json_decode($response, true);
        if (!$decodedResponse) {
            throw new \Exception("Failed to decode Gemini API response");
        }

        return $decodedResponse;
    }

    /**
     * Fallback SEO metadata parsing
     */
    private function fallbackParseSEOMetadata(string $response): array
    {
        $metadata = $this->getDefaultSEOMetadata();
        
        // Extract title
        if (preg_match('/title["\']?\s*[:=]\s*["\']([^"\']+)["\']?/i', $response, $matches)) {
            $metadata['title'] = trim($matches[1]);
        }
        
        // Extract description
        if (preg_match('/description["\']?\s*[:=]\s*["\']([^"\']+)["\']?/i', $response, $matches)) {
            $metadata['description'] = trim($matches[1]);
        }
        
        // Extract keywords
        if (preg_match('/keywords["\']?\s*[:=]\s*\[(.*?)\]/i', $response, $matches)) {
            $keywords = array_map('trim', explode(',', str_replace(['"', "'"], '', $matches[1])));
            $metadata['keywords'] = $keywords;
        }
        
        return $metadata;
    }

    /**
     * Fallback sentiment parsing
     */
    private function fallbackParseSentiment(string $response): array
    {
        $sentiment = $this->getDefaultSentimentAnalysis();
        
        // Extract sentiment score
        if (preg_match('/sentiment.*?score["\']?\s*[:=]\s*(-?\d+\.?\d*)/i', $response, $matches)) {
            $sentiment['sentiment_score'] = (float)$matches[1];
        }
        
        // Extract sentiment label
        if (preg_match('/sentiment.*?label["\']?\s*[:=]\s*["\']?(\w+)["\']?/i', $response, $matches)) {
            $sentiment['sentiment_label'] = strtolower($matches[1]);
        }
        
        return $sentiment;
    }

    /**
     * Default SEO metadata
     */
    private function getDefaultSEOMetadata(): array
    {
        return [
            'title' => 'Ti√™u ƒë·ªÅ ƒë∆∞·ª£c t·∫°o b·ªüi Gemini AI',
            'description' => 'M√¥ t·∫£ SEO ƒë∆∞·ª£c t·∫°o b·ªüi Gemini AI',
            'keywords' => ['ai', 'gemini', 'content', 'marketing', 'vietnam'],
            'og_title' => 'Ti√™u ƒë·ªÅ ƒë∆∞·ª£c t·∫°o b·ªüi Gemini AI',
            'og_description' => 'M√¥ t·∫£ OG ƒë∆∞·ª£c t·∫°o b·ªüi Gemini AI',
            'schema_suggestions' => ['Article', 'WebPage', 'BlogPosting'],
            'seo_score' => 75,
            'optimization_tips' => ['Th√™m target keyword v√†o title', 'C·∫£i thi·ªán meta description']
        ];
    }

    /**
     * Default sentiment analysis
     */
    private function getDefaultSentimentAnalysis(): array
    {
        return [
            'sentiment_score' => 0.0,
            'sentiment_label' => 'neutral',
            'confidence' => 0.5,
            'emotions' => [
                'neutral' => 1.0
            ],
            'key_phrases' => [
                'positive' => [],
                'negative' => [],
                'neutral' => []
            ],
            'tone_markers' => [],
            'marketing_insights' => [
                'brand_perception' => 'neutral',
                'audience_response' => 'moderate',
                'conversion_potential' => 'medium'
            ],
            'recommendations' => ['Kh√¥ng th·ªÉ ph√¢n t√≠ch sentiment t·ª´ Gemini response']
        ];
    }
}